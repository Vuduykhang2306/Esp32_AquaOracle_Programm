/*
 * ============================================================================
 * HIá»†U CHá»ˆNH Cáº¢M BIáº¾N pH - DFRobot SEN0161-V2
 * ============================================================================
 * HÆ¯á»šNG DáºªN HIá»†U CHá»ˆNH 2 ÄIá»‚M (TWO-POINT CALIBRATION):
 * 
 * BÆ¯á»šC 1: NgÃ¢m pH probe vÃ o dung dá»‹ch pH 7.0
 *   - Äá»£i 2 phÃºt cho á»•n Ä‘á»‹nh
 *   - Ghi láº¡i Ä‘iá»‡n Ã¡p hiá»ƒn thá»‹ trong Serial Monitor â†’ gÃ¡n vÃ o VOLTAGE_PH7
 * 
 * BÆ¯á»šC 2: Rá»­a probe báº±ng nÆ°á»›c cáº¥t, lau khÃ´
 * 
 * BÆ¯á»šC 3: NgÃ¢m pH probe vÃ o dung dá»‹ch pH 4.0
 *   - Äá»£i 2 phÃºt cho á»•n Ä‘á»‹nh  
 *   - Ghi láº¡i Ä‘iá»‡n Ã¡p hiá»ƒn thá»‹ â†’ gÃ¡n vÃ o VOLTAGE_PH4
 * 
 * BÆ¯á»šC 4: Cáº­p nháº­t code vá»›i 2 giÃ¡ trá»‹ Ä‘iá»‡n Ã¡p vá»«a Ä‘o
 * ============================================================================
 */

// ============================================================================
// THÃ”NG Sá» HIá»†U CHá»ˆNH - Cáº¬P NHáº¬T SAU KHI ÄO
// ============================================================================
// âš ï¸ Báº N Cáº¦N THAY THáº¾ CÃC GIÃ TRá»Š NÃ€Y SAU KHI HIá»†U CHá»ˆNH
float VOLTAGE_PH7 = 1.50;  // Äiá»‡n Ã¡p Ä‘o Ä‘Æ°á»£c táº¡i pH 7.0 (V) - PHáº¢I ÄO THá»°C Táº¾!
float VOLTAGE_PH4 = 2.03;  // Äiá»‡n Ã¡p Ä‘o Ä‘Æ°á»£c táº¡i pH 4.0 (V) - PHáº¢I ÄO THá»°C Táº¾!

// ThÃ´ng sá»‘ chuáº©n tá»« datasheet
const float PH_REFERENCE_7 = 7.0;
const float PH_REFERENCE_4 = 4.0;
const float ADC_RESOLUTION = 4095.0;  // ESP32 12-bit ADC
const float ADC_VREF = 3.3;           // Äiá»‡n Ã¡p tham chiáº¿u ESP32

// Há»‡ sá»‘ tÃ­nh tá»« hiá»‡u chá»‰nh (tá»± Ä‘á»™ng tÃ­nh)
float acidSlope = 0.0;    // Äá»™ dá»‘c Ä‘Æ°á»ng chuáº©n
float neutralVoltage = 0.0; // Äiá»‡n Ã¡p táº¡i pH trung tÃ­nh

// ============================================================================
// CHá»¨C NÄ‚NG HIá»†U CHá»ˆNH - Gá»ŒI 1 Láº¦N TRONG SETUP()
// ============================================================================
void calibratePH() {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘   HIá»†U CHá»ˆNH Cáº¢M BIáº¾N pH SEN0161-V2       â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  // Kiá»ƒm tra xem Ä‘Ã£ hiá»‡u chá»‰nh chÆ°a
  if (VOLTAGE_PH7 == 1.50 && VOLTAGE_PH4 == 2.03) {
    Serial.println("âš ï¸  Cáº¢NH BÃO: Äang dÃ¹ng giÃ¡ trá»‹ máº·c Ä‘á»‹nh!");
    Serial.println("    Báº¡n cáº§n hiá»‡u chá»‰nh báº±ng dung dá»‹ch chuáº©n");
    Serial.println("    pH 4.0 vÃ  pH 7.0 Ä‘á»ƒ cÃ³ Ä‘á»™ chÃ­nh xÃ¡c cao");
    Serial.println();
  }
  
  // TÃ­nh há»‡ sá»‘ tá»« 2 Ä‘iá»ƒm hiá»‡u chá»‰nh
  acidSlope = (PH_REFERENCE_7 - PH_REFERENCE_4) / (VOLTAGE_PH7 - VOLTAGE_PH4);
  neutralVoltage = VOLTAGE_PH7;
  
  Serial.println("ğŸ“Š THÃ”NG Sá» HIá»†U CHá»ˆNH:");
  Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
  Serial.printf("â”‚ Äiá»‡n Ã¡p táº¡i pH 7.0: %.3f V            â”‚\n", VOLTAGE_PH7);
  Serial.printf("â”‚ Äiá»‡n Ã¡p táº¡i pH 4.0: %.3f V            â”‚\n", VOLTAGE_PH4);
  Serial.printf("â”‚ Äá»™ dá»‘c (Slope):     %.3f pH/V         â”‚\n", acidSlope);
  Serial.printf("â”‚ Äiá»‡n Ã¡p trung tÃ­nh: %.3f V            â”‚\n", neutralVoltage);
  Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
  
  // Kiá»ƒm tra tÃ­nh há»£p lá»‡
  if (abs(acidSlope) < 2.0 || abs(acidSlope) > 4.5) {
    Serial.println("âš ï¸  Cáº£nh bÃ¡o: Äá»™ dá»‘c báº¥t thÆ°á»ng!");
    Serial.println("    GiÃ¡ trá»‹ chuáº©n: -3.0 Ä‘áº¿n -3.5 pH/V");
    Serial.println("    â†’ Kiá»ƒm tra láº¡i hiá»‡u chá»‰nh");
  } else {
    Serial.println("âœ“ Hiá»‡u chá»‰nh há»£p lá»‡!");
  }
  Serial.println();
}

// ============================================================================
// Äá»ŒC pH Vá»šI HIá»†U CHá»ˆNH VÃ€ BÃ™ NHIá»†T Äá»˜
// ============================================================================
float readPH_Calibrated(float temperature = 25.0) {
  // Äá»c ADC (trung bÃ¬nh 10 máº«u)
  int adcSum = 0;
  for (int i = 0; i < 10; i++) {
    adcSum += analogRead(PIN_PH);
    delay(10);
  }
  float adcValue = adcSum / 10.0;
  
  // Chuyá»ƒn Ä‘á»•i ADC sang Ä‘iá»‡n Ã¡p
  float voltage = adcValue * (ADC_VREF / ADC_RESOLUTION);
  
  // TÃ­nh pH tá»« cÃ´ng thá»©c hiá»‡u chá»‰nh 2 Ä‘iá»ƒm
  float phValue = PH_REFERENCE_7 + acidSlope * (voltage - neutralVoltage);
  
  // BÃ¹ nhiá»‡t Ä‘á»™ (pH thay Ä‘á»•i ~0.003 Ä‘Æ¡n vá»‹/Â°C)
  float tempCompensation = 0.003 * (temperature - 25.0);
  phValue = phValue - tempCompensation;
  
  // Giá»›i háº¡n trong khoáº£ng há»£p lá»‡
  phValue = constrain(phValue, 0.0, 14.0);
  
  // Hiá»ƒn thá»‹ chi tiáº¿t
  Serial.printf("   â”œâ”€ ADC Raw: %.0f / 4095\n", adcValue);
  Serial.printf("   â”œâ”€ Voltage: %.3f V\n", voltage);
  Serial.printf("   â”œâ”€ pH (uncalibrated): %.2f\n", 
                PH_REFERENCE_7 + acidSlope * (voltage - neutralVoltage));
  Serial.printf("   â”œâ”€ Temperature: %.1f Â°C\n", temperature);
  Serial.printf("   â”œâ”€ Temp compensation: %.3f pH\n", tempCompensation);
  Serial.printf("   â””â”€ âœ“ pH (calibrated): %.2f\n", phValue);
  
  return phValue;
}

// ============================================================================
// CHáº¾ Äá»˜ HIá»†U CHá»ˆNH THá»¦ CÃ”NG (Gá»ŒI TRONG LOOP Äá»‚ KIá»‚M TRA)
// ============================================================================
void manualCalibrationMode() {
  Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("  CHáº¾ Äá»˜ HIá»†U CHá»ˆNH pH MANUAL");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("HÆ°á»›ng dáº«n:");
  Serial.println("1. NgÃ¢m probe vÃ o dung dá»‹ch pH 7.0");
  Serial.println("2. Äá»£i 2 phÃºt, ghi láº¡i Ä‘iá»‡n Ã¡p");
  Serial.println("3. Rá»­a probe, ngÃ¢m vÃ o pH 4.0");
  Serial.println("4. Äá»£i 2 phÃºt, ghi láº¡i Ä‘iá»‡n Ã¡p");
  Serial.println("5. Cáº­p nháº­t VOLTAGE_PH7 vÃ  VOLTAGE_PH4");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  for (int i = 0; i < 20; i++) {  // Äá»c 20 láº§n
    // Äá»c ADC
    int adcSum = 0;
    for (int j = 0; j < 10; j++) {
      adcSum += analogRead(PIN_PH);
      delay(10);
    }
    float adcValue = adcSum / 10.0;
    float voltage = adcValue * (ADC_VREF / ADC_RESOLUTION);
    
    Serial.printf("Máº«u %2d: ADC=%4.0f, Voltage=%.3fV\n", 
                  i+1, adcValue, voltage);
    delay(1000);
  }
  
  Serial.println("\nâ†’ Ghi láº¡i giÃ¡ trá»‹ Ä‘iá»‡n Ã¡p trung bÃ¬nh");
  Serial.println("â†’ Cáº­p nháº­t vÃ o VOLTAGE_PH7 hoáº·c VOLTAGE_PH4\n");
}

// ============================================================================
// THAY THáº¾ HÃ€M readPH() CÅ¨ Báº°NG HÃ€M Má»šI
// ============================================================================
// TRONG SETUP(), THÃŠM DÃ’NG:
// calibratePH();

// TRONG readAllSensors(), THAY Äá»”I:
// float temp = readTemperature();  // Äá»c nhiá»‡t Ä‘á»™ trÆ°á»›c
// data.ph = readPH_Calibrated(temp);  // Truyá»n nhiá»‡t Ä‘á»™ vÃ o

/*
 * ============================================================================
 * HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG CHI TIáº¾T
 * ============================================================================
 * 
 * BÆ¯á»šC 1: CHUáº¨N Bá»Š
 * - Chuáº©n bá»‹ 2 cá»‘c dung dá»‹ch chuáº©n pH 4.0 vÃ  pH 7.0 (Ä‘i kÃ¨m sáº£n pháº©m)
 * - Chuáº©n bá»‹ nÆ°á»›c cáº¥t Ä‘á»ƒ rá»­a probe
 * - Giáº¥y tháº¥m má»m Ä‘á»ƒ lau khÃ´ probe
 * 
 * BÆ¯á»šC 2: HIá»†U CHá»ˆNH ÄIá»‚M THá»¨ NHáº¤T (pH 7.0)
 * 1. Upload code vá»›i cháº¿ Ä‘á»™ manualCalibrationMode() trong loop
 * 2. NgÃ¢m probe vÃ o dung dá»‹ch pH 7.0
 * 3. Äá»£i 2 phÃºt cho á»•n Ä‘á»‹nh
 * 4. Quan sÃ¡t Serial Monitor, ghi láº¡i giÃ¡ trá»‹ Ä‘iá»‡n Ã¡p trung bÃ¬nh
 * 5. Cáº­p nháº­t giÃ¡ trá»‹ vÃ o biáº¿n VOLTAGE_PH7
 * 
 * BÆ¯á»šC 3: HIá»†U CHá»ˆNH ÄIá»‚M THá»¨ HAI (pH 4.0)
 * 1. Rá»­a probe báº±ng nÆ°á»›c cáº¥t, lau khÃ´ nháº¹
 * 2. NgÃ¢m probe vÃ o dung dá»‹ch pH 4.0
 * 3. Äá»£i 2 phÃºt cho á»•n Ä‘á»‹nh
 * 4. Ghi láº¡i giÃ¡ trá»‹ Ä‘iá»‡n Ã¡p trung bÃ¬nh
 * 5. Cáº­p nháº­t giÃ¡ trá»‹ vÃ o biáº¿n VOLTAGE_PH4
 * 
 * BÆ¯á»šC 4: HOÃ€N Táº¤T
 * 1. Upload láº¡i code vá»›i 2 giÃ¡ trá»‹ Ä‘iá»‡n Ã¡p má»›i
 * 2. Gá»i calibratePH() trong setup()
 * 3. Kiá»ƒm tra Ä‘á»™ chÃ­nh xÃ¡c báº±ng dung dá»‹ch chuáº©n
 * 
 * LÆ¯U Ã Báº¢O QUáº¢N:
 * - LuÃ´n ngÃ¢m probe trong dung dá»‹ch báº£o quáº£n (pH 4.0) khi khÃ´ng dÃ¹ng
 * - KHÃ”NG Ä‘á»ƒ probe khÃ´, sáº½ lÃ m há»ng mÃ ng thá»§y tinh
 * - Hiá»‡u chá»‰nh láº¡i má»—i 1-2 thÃ¡ng hoáº·c khi phÃ¡t hiá»‡n sai sá»‘
 * - Thay probe sau 6-12 thÃ¡ng tÃ¹y táº§n suáº¥t sá»­ dá»¥ng
 * 
 * KIá»‚M TRA SAI Sá»:
 * - Sai sá»‘ cho phÃ©p: Â±0.1 pH @ 25Â°C (theo datasheet)
 * - Náº¿u sai sá»‘ > Â±0.2 pH â†’ cáº§n hiá»‡u chá»‰nh láº¡i
 * - Náº¿u váº«n sai â†’ kiá»ƒm tra probe (cÃ³ thá»ƒ há»ng)
 * 
 * ============================================================================
 */
